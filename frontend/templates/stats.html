<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Stats Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a0f;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: #111118;
            border-bottom: 1px solid #222;
        }
        .header h1 { font-size: 20px; color: #fff; }
        .back-btn {
            background: #1a1a2e;
            color: #7b8cff;
            border: 1px solid #333;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
        }
        .back-btn:hover { background: #252545; }
        .container { padding: 20px 24px; max-width: 1400px; margin: 0 auto; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .card {
            background: #111118;
            border: 1px solid #1e1e2e;
            border-radius: 10px;
            padding: 16px;
        }
        .card h2 {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 12px;
            border-bottom: 1px solid #1e1e2e;
            padding-bottom: 8px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #0d0d14;
        }
        .stat-label { color: #999; font-size: 13px; }
        .stat-value { font-weight: 600; font-size: 13px; }
        .stat-value.green { color: #26a69a; }
        .stat-value.red { color: #ef5350; }
        .stat-value.yellow { color: #ffca28; }
        .stat-value.blue { color: #42a5f5; }

        .big-number {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            padding: 12px 0;
        }
        .big-label {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: -8px;
            margin-bottom: 8px;
        }

        .winrate-bar {
            height: 8px;
            background: #1a1a2e;
            border-radius: 4px;
            overflow: hidden;
            margin: 4px 0 8px;
        }
        .winrate-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s;
        }

        .predictions-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .predictions-table th {
            text-align: left;
            padding: 8px 6px;
            color: #666;
            border-bottom: 1px solid #222;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
        }
        .predictions-table td {
            padding: 6px;
            border-bottom: 1px solid #0d0d14;
        }
        .predictions-table tr:hover { background: #151520; }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge.bullish { background: rgba(38,166,154,0.2); color: #26a69a; }
        .badge.bearish { background: rgba(239,83,80,0.2); color: #ef5350; }
        .badge.rth { background: rgba(66,165,245,0.15); color: #42a5f5; }
        .badge.overnight { background: rgba(171,130,255,0.15); color: #ab82ff; }

        .refresh-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .refresh-btn {
            background: #1a1a2e;
            color: #7b8cff;
            border: 1px solid #333;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .refresh-btn:hover { background: #252545; }
        .last-update { color: #555; font-size: 12px; }

        .section-title {
            font-size: 16px;
            color: #ccc;
            margin: 24px 0 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #1e1e2e;
        }

        .no-data {
            color: #555;
            text-align: center;
            padding: 40px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Trading Statistics Dashboard</h1>
        <a href="/" class="back-btn">Back to Chart</a>
    </div>

    <div class="container">
        <div class="refresh-bar">
            <button class="refresh-btn" onclick="loadAllStats()">Refresh</button>
            <span class="last-update" id="lastUpdate">Loading...</span>
            <span style="margin-left:auto; color:#555; font-size:12px;">Auto-refreshes every 30s</span>
        </div>

        <!-- Bracket Resolution Stats -->
        <div class="section-title">Bracket Resolution (Primary Metric)</div>
        <div class="stats-grid" id="bracketCards">
            <div class="card"><div class="no-data">Loading bracket stats...</div></div>
        </div>

        <!-- Bracket Trade Log -->
        <div class="section-title">Recent Bracket Trades</div>
        <div class="card" id="bracketTradesCard">
            <div class="no-data">Loading bracket trades...</div>
        </div>

        <!-- Setup Leaderboard -->
        <div class="section-title">Setup Leaderboard (Multi-Strategy Testing)</div>
        <div class="card" id="setupLeaderboardCard">
            <div class="no-data">Loading setup leaderboard...</div>
        </div>

        <!-- Legacy Signal Stats Cards (deprecated - kept for backward compat) -->
        <details style="margin-bottom:16px">
            <summary class="section-title" style="cursor:pointer;user-select:none">Legacy Time-Snapshot Performance (Today) <span style="color:#555;font-size:12px">[click to expand]</span></summary>
            <p style="color:#666;font-size:12px;padding:8px 0">Deprecated: uses fixed-point thresholds (5/10/15 pts) that ignore ATR and volatility. Use Bracket Resolution above instead.</p>
            <div class="stats-grid" id="signalCards">
                <div class="card"><div class="no-data">Loading signal stats...</div></div>
            </div>
        </details>

        <!-- Pattern Accuracy -->
        <div class="section-title">Pattern Prediction Accuracy</div>
        <div class="stats-grid" id="patternCards">
            <div class="card"><div class="no-data">Loading pattern stats...</div></div>
        </div>

        <!-- Anchored Session Predictions -->
        <div class="section-title">Anchored Session Predictions (Live)</div>
        <div id="sessionCards" class="stats-grid">
            <div class="card"><div class="no-data">Loading session predictions...</div></div>
        </div>

        <!-- Rolling Stats -->
        <div class="section-title">Rolling Performance (7-Day / 30-Day)</div>
        <div class="stats-grid" id="rollingCards">
            <div class="card"><div class="no-data">Loading rolling stats...</div></div>
        </div>

        <!-- Recent Predictions Table -->
        <div class="section-title">Recent Pattern Predictions</div>
        <div class="card" id="predictionsCard">
            <div class="no-data">Loading predictions...</div>
        </div>
    </div>

    <script>
        function formatTime(ts) {
            if (!ts) return '-';
            const d = new Date(ts * 1000);
            return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function pct(n, d) {
            if (!d || d === 0) return '-';
            return (n / d * 100).toFixed(1) + '%';
        }

        function winColor(rate) {
            if (rate === null || rate === undefined) return '#555';
            if (rate >= 0.6) return '#26a69a';
            if (rate >= 0.45) return '#ffca28';
            return '#ef5350';
        }

        function makeWinrateBar(rate, label) {
            const pctVal = rate != null ? (rate * 100).toFixed(1) : 0;
            const color = winColor(rate);
            return `
                <div class="stat-row">
                    <span class="stat-label">${label}</span>
                    <span class="stat-value" style="color:${color}">${rate != null ? pctVal + '%' : 'N/A'}</span>
                </div>
                <div class="winrate-bar">
                    <div class="winrate-fill" style="width:${pctVal}%; background:${color}"></div>
                </div>
            `;
        }

        function renderSignalCards(todayStats) {
            const container = document.getElementById('signalCards');
            if (!todayStats || !todayStats.stats || Object.keys(todayStats.stats).length === 0) {
                container.innerHTML = '<div class="card"><div class="no-data">No signal data yet. Signals will appear as the scalping engine generates BUY/SELL decisions.</div></div>';
                return;
            }

            const sourceLabels = {
                'trade_signal': 'Scalping Engine',
                'rth_pattern': 'Daily Pattern',
                'overnight_pattern': 'Overnight Pattern'
            };

            let html = '';
            for (const [src, s] of Object.entries(todayStats.stats)) {
                const label = sourceLabels[src] || src;
                html += `
                    <div class="card">
                        <h2>${label}</h2>
                        <div class="stat-row">
                            <span class="stat-label">Confirmed Signals</span>
                            <span class="stat-value blue">${s.confirmed || 0}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Resolved</span>
                            <span class="stat-value">${s.resolved || 0}</span>
                        </div>
                        ${makeWinrateBar(s.win_rate_1m, 'Win Rate (1m)')}
                        ${makeWinrateBar(s.win_rate_5m, 'Win Rate (5m)')}
                        ${makeWinrateBar(s.win_rate_15m, 'Win Rate (15m)')}
                        <div class="stat-row">
                            <span class="stat-label">Avg MFE (pts)</span>
                            <span class="stat-value green">${s.avg_mfe || 0}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg MAE (pts)</span>
                            <span class="stat-value red">${s.avg_mae || 0}</span>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function renderPatternCards(patternAccuracy, predictionCounts) {
            const container = document.getElementById('patternCards');
            const sessions = ['rth', 'overnight'];
            const labels = { rth: 'Daily (RTH) Pattern', overnight: 'Overnight Pattern' };

            let html = '';
            for (const st of sessions) {
                const acc = (patternAccuracy || {})[st];
                const pred = (predictionCounts || {})[st];
                html += `
                    <div class="card">
                        <h2>${labels[st]}</h2>
                        <div class="stat-row">
                            <span class="stat-label">Total Predictions Logged</span>
                            <span class="stat-value blue">${pred ? pred.total_predictions : 0}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Days Tracked</span>
                            <span class="stat-value">${pred ? pred.days_tracked : 0}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Snapshots (meaningful changes)</span>
                            <span class="stat-value">${acc ? acc.snapshots : 0}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Evaluated (with actual close)</span>
                            <span class="stat-value">${acc ? acc.evaluated : 0}</span>
                        </div>
                        ${acc && acc.accuracy != null ? makeWinrateBar(acc.accuracy, 'Direction Accuracy') : `
                        <div class="stat-row">
                            <span class="stat-label">Direction Accuracy</span>
                            <span class="stat-value" style="color:#555">Pending evaluation</span>
                        </div>`}
                    </div>
                `;
            }
            container.innerHTML = html || '<div class="card"><div class="no-data">No pattern data yet.</div></div>';
        }

        function renderRollingCards(rolling7d, rolling30d) {
            const container = document.getElementById('rollingCards');
            const sourceLabels = {
                'trade_signal': 'Scalping Engine',
                'rth_pattern': 'Daily Pattern',
                'overnight_pattern': 'Overnight Pattern'
            };

            let html = '';
            for (const src of ['trade_signal', 'rth_pattern', 'overnight_pattern']) {
                const s7 = (rolling7d || {})[src] || {};
                const s30 = (rolling30d || {})[src] || {};
                html += `
                    <div class="card">
                        <h2>${sourceLabels[src]}</h2>
                        <div class="stat-row">
                            <span class="stat-label">Resolved (7d / 30d)</span>
                            <span class="stat-value">${s7.total_resolved || 0} / ${s30.total_resolved || 0}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Win Rate 1m (7d)</span>
                            <span class="stat-value" style="color:${winColor(s7.win_rate_1m)}">${s7.win_rate_1m ? (s7.win_rate_1m*100).toFixed(1)+'%' : 'N/A'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Win Rate 1m (30d)</span>
                            <span class="stat-value" style="color:${winColor(s30.win_rate_1m)}">${s30.win_rate_1m ? (s30.win_rate_1m*100).toFixed(1)+'%' : 'N/A'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Win Rate 5m (7d)</span>
                            <span class="stat-value" style="color:${winColor(s7.win_rate_5m)}">${s7.win_rate_5m ? (s7.win_rate_5m*100).toFixed(1)+'%' : 'N/A'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg MFE / MAE (7d)</span>
                            <span class="stat-value"><span class="green">${s7.avg_mfe || 0}</span> / <span class="red">${s7.avg_mae || 0}</span></span>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html || '<div class="card"><div class="no-data">No rolling data yet.</div></div>';
        }

        function renderSessionCards(sessions) {
            const container = document.getElementById('sessionCards');
            // Merge active + history, dedupe by key
            const all = [...(sessions.active || []), ...(sessions.history || [])];
            const seen = new Set();
            const unique = [];
            for (const s of all) {
                const key = `${s.session_date}-${s.session_type}-${s.symbol}`;
                if (!seen.has(key)) { seen.add(key); unique.push(s); }
            }

            if (unique.length === 0) {
                container.innerHTML = '<div class="card"><div class="no-data">No session predictions yet. Data accumulates as pattern engines run each minute.</div></div>';
                return;
            }

            let html = '';
            for (const s of unique) {
                const dirClass = s.final_direction === 'bullish' ? 'bullish' : 'bearish';
                const anchorClass = s.anchor_direction === 'bullish' ? 'bullish' : 'bearish';
                const stability = s.direction_stability || 0;
                const stabilityColor = stability >= 0.8 ? '#26a69a' : stability >= 0.6 ? '#ffca28' : '#ef5350';
                const sessClass = s.session_type === 'rth' ? 'rth' : 'overnight';
                const isLive = !s.is_closed;

                html += `
                    <div class="card" style="${isLive ? 'border-color:#333' : ''}">
                        <h2>
                            <span class="badge ${sessClass}">${s.session_type}</span>
                            ${s.symbol} - ${s.session_date}
                            ${isLive ? ' <span style="color:#26a69a;font-size:11px">LIVE</span>' : ''}
                        </h2>
                        <div class="stat-row">
                            <span class="stat-label">Anchor Direction</span>
                            <span class="stat-value"><span class="badge ${anchorClass}">${s.anchor_direction}</span> @ ${s.anchor_price ? s.anchor_price.toFixed(1) : '-'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Current Verdict</span>
                            <span class="stat-value"><span class="badge ${dirClass}">${s.final_direction}</span></span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Direction Stability</span>
                            <span class="stat-value" style="color:${stabilityColor}">${(stability * 100).toFixed(1)}%</span>
                        </div>
                        <div class="winrate-bar">
                            <div class="winrate-fill" style="width:${(stability*100)}%; background:${stabilityColor}"></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Votes (Bull / Bear)</span>
                            <span class="stat-value"><span class="green">${s.bullish_votes || 0}</span> / <span class="red">${s.bearish_votes || 0}</span> (${s.total_votes || 0} total)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Regime Changes</span>
                            <span class="stat-value" style="color:${s.regime_changes > 0 ? '#ffca28' : '#666'}">${s.regime_changes || 0}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg EOS Projected</span>
                            <span class="stat-value">${s.avg_eod_projected ? s.avg_eod_projected.toFixed(1) : '-'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg Peak Projected</span>
                            <span class="stat-value">${s.avg_peak_projected ? s.avg_peak_projected.toFixed(1) : '-'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Last Price</span>
                            <span class="stat-value">${s.last_price ? s.last_price.toFixed(1) : '-'}</span>
                        </div>
                        ${s.direction_correct !== null && s.direction_correct !== undefined ? `
                        <div class="stat-row">
                            <span class="stat-label">Direction Correct?</span>
                            <span class="stat-value ${s.direction_correct ? 'green' : 'red'}">${s.direction_correct ? 'YES' : 'NO'}</span>
                        </div>` : ''}
                        ${s.eod_error_points ? `
                        <div class="stat-row">
                            <span class="stat-label">EOS Error (pts)</span>
                            <span class="stat-value">${s.eod_error_points.toFixed(1)}</span>
                        </div>` : ''}
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function renderPredictions(predictions) {
            const container = document.getElementById('predictionsCard');
            if (!predictions || predictions.length === 0) {
                container.innerHTML = '<div class="no-data">No predictions logged yet. Predictions are logged every 60 seconds when pattern engines run.</div>';
                return;
            }

            let html = `<table class="predictions-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Session</th>
                        <th>Symbol</th>
                        <th>Direction</th>
                        <th>Consensus</th>
                        <th>Correlation</th>
                        <th>Price</th>
                        <th>EOS Proj</th>
                        <th>Peak Proj</th>
                        <th>Mean Move</th>
                        <th>Matches</th>
                    </tr>
                </thead><tbody>`;

            for (const p of predictions) {
                const dirClass = p.direction === 'bullish' ? 'bullish' : 'bearish';
                const sessClass = p.session_type === 'rth' ? 'rth' : 'overnight';
                html += `<tr>
                    <td>${formatTime(p.timestamp)}</td>
                    <td><span class="badge ${sessClass}">${p.session_type}</span></td>
                    <td>${p.symbol || ''}</td>
                    <td><span class="badge ${dirClass}">${p.direction || ''}</span></td>
                    <td>${p.consensus || ''}</td>
                    <td>${p.avg_correlation ? p.avg_correlation.toFixed(3) : '-'}</td>
                    <td>${p.current_price ? p.current_price.toFixed(1) : '-'}</td>
                    <td>${p.eod_projected_price ? p.eod_projected_price.toFixed(1) : '-'}</td>
                    <td>${p.peak_projected_price ? p.peak_projected_price.toFixed(1) : '-'}</td>
                    <td>${p.mean_move ? p.mean_move.toFixed(2) + '%' : '-'}</td>
                    <td>${p.match_count || 0}</td>
                </tr>`;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function outcomeColor(outcome) {
            if (outcome === 'TARGET_HIT') return '#26a69a';
            if (outcome === 'STOP_HIT') return '#ef5350';
            if (outcome === 'TRAILING_STOP' || outcome === 'BREAKEVEN_STOP') return '#ffca28';
            if (outcome === 'TIMEOUT_PROFIT') return '#66bb6a';
            if (outcome === 'TIMEOUT_LOSS') return '#ff7043';
            if (outcome === 'TIMEOUT_SCRATCH') return '#888';
            return '#555';
        }

        function rColor(r) {
            if (r === null || r === undefined) return '#555';
            if (r >= 1.0) return '#26a69a';
            if (r > 0) return '#66bb6a';
            if (r > -0.5) return '#ffca28';
            return '#ef5350';
        }

        function renderBracketCards(bracketToday, bracketAll, bracket7d, bracket30d) {
            const container = document.getElementById('bracketCards');

            const sections = [
                { label: 'Today', data: bracketToday },
                { label: 'All Time', data: bracketAll },
                { label: '7-Day Rolling', data: bracket7d },
                { label: '30-Day Rolling', data: bracket30d },
            ];

            let html = '';
            for (const { label, data } of sections) {
                if (!data || !data.total_trades) {
                    html += `<div class="card"><h2>${label}</h2><div class="no-data">No bracket data</div></div>`;
                    continue;
                }
                const s = data;
                const wr = s.bracket_win_rate;
                const wrPct = wr !== null && wr !== undefined ? (wr * 100).toFixed(1) + '%' : 'N/A';
                const wrC = winColor(wr);
                const pr = s.profitable_rate;
                const prPct = pr !== null && pr !== undefined ? (pr * 100).toFixed(1) + '%' : 'N/A';

                html += `
                    <div class="card">
                        <h2>${label}</h2>
                        <div class="big-number" style="color:${wrC}">${wrPct}</div>
                        <div class="big-label">Bracket Win Rate (Target / (Target+Stop))</div>

                        <div class="stat-row">
                            <span class="stat-label">Total Trades</span>
                            <span class="stat-value blue">${s.total_trades}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Target Hits / Stop Hits</span>
                            <span class="stat-value"><span class="green">${s.target_hits || 0}</span> / <span class="red">${s.stop_hits || 0}</span></span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Trailing/BE Exits</span>
                            <span class="stat-value yellow">${s.trailing_exits || 0}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Timeouts / Scratches</span>
                            <span class="stat-value">${s.timeouts || 0} / ${s.scratches || 0}</span>
                        </div>

                        <div class="stat-row">
                            <span class="stat-label">Avg R-Multiple</span>
                            <span class="stat-value" style="color:${rColor(s.avg_r)}">${s.avg_r !== null ? s.avg_r.toFixed(3) + 'R' : 'N/A'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total R</span>
                            <span class="stat-value" style="color:${rColor(s.total_r)}">${s.total_r !== null ? s.total_r.toFixed(2) + 'R' : 'N/A'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Expectancy</span>
                            <span class="stat-value" style="color:${rColor(s.expectancy)}">${s.expectancy ? s.expectancy.toFixed(3) + 'R' : (s.avg_r ? s.avg_r.toFixed(3) + 'R' : 'N/A')}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">SQN</span>
                            <span class="stat-value" style="color:${s.sqn && s.sqn > 2 ? '#26a69a' : s.sqn && s.sqn > 1 ? '#ffca28' : '#ef5350'}">${s.sqn ? s.sqn.toFixed(2) : 'N/A'}</span>
                        </div>

                        <div class="stat-row">
                            <span class="stat-label">Profitable Rate</span>
                            <span class="stat-value" style="color:${winColor(pr)}">${prPct}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg MFE / MAE (R)</span>
                            <span class="stat-value"><span class="green">${s.avg_mfe_r ? s.avg_mfe_r.toFixed(2) : '-'}</span> / <span class="red">${s.avg_mae_r ? s.avg_mae_r.toFixed(2) : '-'}</span></span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg ETD from MFE (R)</span>
                            <span class="stat-value">${s.avg_etd_r ? s.avg_etd_r.toFixed(2) : '-'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg Bars Held</span>
                            <span class="stat-value">${s.avg_bars_held ? s.avg_bars_held.toFixed(1) : '-'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg Quality Score</span>
                            <span class="stat-value">${s.avg_quality ? s.avg_quality.toFixed(1) + '/100' : '-'}</span>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html || '<div class="card"><div class="no-data">No bracket resolution data yet. Requires ATR > 0 in trade signals.</div></div>';
        }

        function renderBracketTrades(trades) {
            const container = document.getElementById('bracketTradesCard');
            if (!trades || trades.length === 0) {
                container.innerHTML = '<div class="no-data">No bracket trades resolved yet.</div>';
                return;
            }

            let html = `<table class="predictions-table">
                <thead><tr>
                    <th>Time</th>
                    <th>Symbol</th>
                    <th>Dir</th>
                    <th>Entry</th>
                    <th>Stop</th>
                    <th>Target</th>
                    <th>Exit</th>
                    <th>Outcome</th>
                    <th>R-Mult</th>
                    <th>MFE(R)</th>
                    <th>MAE(R)</th>
                    <th>ETD(R)</th>
                    <th>Bars</th>
                    <th>Trail</th>
                    <th>Quality</th>
                </tr></thead><tbody>`;

            for (const t of trades) {
                const dirClass = t.direction === 'LONG' ? 'bullish' : 'bearish';
                const oc = outcomeColor(t.outcome);
                const rc = rColor(t.r_multiple);
                html += `<tr>
                    <td>${formatTime(t.entry_time)}</td>
                    <td>${t.symbol || ''}</td>
                    <td><span class="badge ${dirClass}">${t.direction}</span></td>
                    <td>${t.entry_price ? t.entry_price.toFixed(1) : '-'}</td>
                    <td style="color:#ef5350">${t.stop_price ? t.stop_price.toFixed(1) : '-'}</td>
                    <td style="color:#26a69a">${t.target_price ? t.target_price.toFixed(1) : '-'}</td>
                    <td>${t.exit_price ? t.exit_price.toFixed(1) : '-'}</td>
                    <td style="color:${oc};font-weight:600">${t.outcome || '-'}</td>
                    <td style="color:${rc};font-weight:600">${t.r_multiple !== null ? t.r_multiple.toFixed(2) + 'R' : '-'}</td>
                    <td class="green">${t.mfe_r ? t.mfe_r.toFixed(2) : '-'}</td>
                    <td class="red">${t.mae_r ? t.mae_r.toFixed(2) : '-'}</td>
                    <td>${t.etd_from_mfe_r ? t.etd_from_mfe_r.toFixed(2) : '-'}</td>
                    <td>${t.bars_held || '-'}</td>
                    <td>${t.trailing_stop_state || '-'}</td>
                    <td>${t.quality_score ? t.quality_score.toFixed(0) : '-'}</td>
                </tr>`;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderSetupLeaderboard(data) {
            const container = document.getElementById('setupLeaderboardCard');
            const leaderboard = data.leaderboard || [];
            const detectors = data.detectors || [];

            if (leaderboard.length === 0 && detectors.length === 0) {
                container.innerHTML = '<div class="no-data">No setup detectors registered yet. Phase 1 detectors coming soon.</div>';
                return;
            }

            let html = '';

            // Detector grid ‚Äî always show all registered setups
            if (detectors.length > 0) {
                const tierColors = {1: '#26a69a', 2: '#29b6f6', 3: '#ffca28', 4: '#ef5350'};
                const tierLabels = {1: 'T1', 2: 'T2', 3: 'T3', 4: 'T4'};
                const catIcons = {
                    breakout: 'üî∫', mean_reversion: 'üîÑ', momentum: '‚ö°', level: 'üìè',
                    volatility: 'üí•', micro: 'üî¨', vwap: 'üìä', unknown: '‚ùì'
                };
                html += `<div style="margin-bottom:14px;color:#aaa;font-size:13px;font-weight:600">${detectors.length} Setups Registered &nbsp;|&nbsp; ${detectors.filter(d=>d.enabled).length} Enabled &nbsp;|&nbsp; ${detectors.reduce((s,d)=>s+d.signal_count,0)} Signals Emitted</div>`;
                html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;margin-bottom:16px">';
                for (const d of detectors) {
                    const tc = tierColors[d.evidence_tier] || '#888';
                    const tl = tierLabels[d.evidence_tier] || '?';
                    const icon = catIcons[d.category] || '‚ùì';
                    const sigTxt = d.signal_count > 0 ? `<span style="color:#26a69a;font-weight:600">${d.signal_count} signals</span>` : '<span style="color:#555">0 signals</span>';
                    html += `<div style="background:#1e1e2f;border:1px solid ${d.enabled ? '#333' : '#2a1a1a'};border-radius:8px;padding:10px 12px;${!d.enabled ? 'opacity:0.5;' : ''}">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                            <span style="font-size:12px;font-weight:700;color:#ddd">${icon} ${d.display_name}</span>
                            <span style="font-size:10px;font-weight:700;color:${tc};background:${tc}22;padding:1px 6px;border-radius:4px">${tl}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:11px;color:#777">
                            <span>${d.category} ¬∑ ${d.hold_time}</span>
                            ${sigTxt}
                        </div>
                    </div>`;
                }
                html += '</div>';
            }

            if (leaderboard.length === 0) {
                html += '<div class="no-data" style="padding:12px;color:#666">No resolved setup trades yet. Setups will appear in the leaderboard once signals fire and resolve.</div>';
                container.innerHTML = html;
                return;
            }

            html += `<table class="predictions-table">
                <thead><tr>
                    <th>Setup</th>
                    <th>Trades</th>
                    <th>Win Rate</th>
                    <th>Avg R</th>
                    <th>Total R</th>
                    <th>SQN</th>
                    <th>MFE(R)</th>
                    <th>MAE(R)</th>
                    <th>ETD(R)</th>
                    <th>Avg Bars</th>
                    <th>Targets</th>
                    <th>Stops</th>
                    <th>Timeouts</th>
                </tr></thead><tbody>`;

            for (const s of leaderboard) {
                const wr = s.bracket_win_rate;
                const wrColor = winColor(wr);
                const avgRColor = s.avg_r > 0 ? '#26a69a' : s.avg_r < 0 ? '#ef5350' : '#888';
                const totalRColor = s.total_r > 0 ? '#26a69a' : s.total_r < 0 ? '#ef5350' : '#888';
                const sqnColor = s.sqn >= 2 ? '#26a69a' : s.sqn >= 1 ? '#ffca28' : '#ef5350';

                html += `<tr>
                    <td style="font-weight:600;color:#ccc">${s.setup_name}</td>
                    <td>${s.total_trades}</td>
                    <td style="color:${wrColor};font-weight:600">${wr !== null ? (wr * 100).toFixed(1) + '%' : '-'}</td>
                    <td style="color:${avgRColor};font-weight:600">${s.avg_r !== null ? s.avg_r.toFixed(3) + 'R' : '-'}</td>
                    <td style="color:${totalRColor};font-weight:600">${s.total_r !== null ? s.total_r.toFixed(2) + 'R' : '-'}</td>
                    <td style="color:${sqnColor}">${s.sqn !== null ? s.sqn.toFixed(2) : '-'}</td>
                    <td class="green">${s.avg_mfe_r ? s.avg_mfe_r.toFixed(2) : '-'}</td>
                    <td class="red">${s.avg_mae_r ? s.avg_mae_r.toFixed(2) : '-'}</td>
                    <td>${s.avg_etd_r ? s.avg_etd_r.toFixed(2) : '-'}</td>
                    <td>${s.avg_bars_held ? s.avg_bars_held.toFixed(1) : '-'}</td>
                    <td class="green">${s.target_hits}</td>
                    <td class="red">${s.stop_hits}</td>
                    <td style="color:#ffca28">${s.timeouts}</td>
                </tr>`;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function loadAllStats() {
            try {
                const [resp, sessResp, setupResp] = await Promise.all([
                    fetch('/api/stats/full'),
                    fetch('/api/stats/sessions'),
                    fetch('/api/stats/setups'),
                ]);
                if (!resp.ok) {
                    const errText = await resp.text();
                    console.error('Stats API error:', resp.status, errText);
                    document.getElementById('lastUpdate').textContent =
                        'Stats API error: ' + resp.status;
                    return;
                }
                const data = await resp.json();
                const sessData = sessResp.ok ? await sessResp.json() : [];

                renderBracketCards(data.bracket_today, data.bracket_all, data.bracket_7d, data.bracket_30d);
                renderBracketTrades(data.bracket_trades);
                if (setupResp.ok) {
                    const setupData = await setupResp.json();
                    renderSetupLeaderboard(setupData);
                }
                renderSignalCards(data.signal_stats);
                renderPatternCards(data.pattern_accuracy, data.prediction_counts);
                renderSessionCards(sessData);
                renderRollingCards(data.rolling_7d, data.rolling_30d);
                renderPredictions(data.recent_predictions);

                document.getElementById('lastUpdate').textContent =
                    'Last updated: ' + new Date().toLocaleTimeString();
            } catch (err) {
                console.error('Failed to load stats:', err);
                document.getElementById('lastUpdate').textContent = 'Error loading stats';
            }
        }

        // Load on page open
        loadAllStats();

        // Auto-refresh every 30 seconds
        setInterval(loadAllStats, 30000);
    </script>
</body>
</html>
