<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Stats Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a0f;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: #111118;
            border-bottom: 1px solid #222;
        }
        .header h1 { font-size: 20px; color: #fff; }
        .back-btn {
            background: #1a1a2e;
            color: #7b8cff;
            border: 1px solid #333;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
        }
        .back-btn:hover { background: #252545; }
        .container { padding: 20px 24px; max-width: 1400px; margin: 0 auto; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .card {
            background: #111118;
            border: 1px solid #1e1e2e;
            border-radius: 10px;
            padding: 16px;
        }
        .card h2 {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 12px;
            border-bottom: 1px solid #1e1e2e;
            padding-bottom: 8px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #0d0d14;
        }
        .stat-label { color: #999; font-size: 13px; }
        .stat-value { font-weight: 600; font-size: 13px; }
        .stat-value.green { color: #26a69a; }
        .stat-value.red { color: #ef5350; }
        .stat-value.yellow { color: #ffca28; }
        .stat-value.blue { color: #42a5f5; }

        .big-number {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            padding: 12px 0;
        }
        .big-label {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: -8px;
            margin-bottom: 8px;
        }

        .winrate-bar {
            height: 8px;
            background: #1a1a2e;
            border-radius: 4px;
            overflow: hidden;
            margin: 4px 0 8px;
        }
        .winrate-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s;
        }

        .predictions-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .predictions-table th {
            text-align: left;
            padding: 8px 6px;
            color: #666;
            border-bottom: 1px solid #222;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
        }
        .predictions-table td {
            padding: 6px;
            border-bottom: 1px solid #0d0d14;
        }
        .predictions-table tr:hover { background: #151520; }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge.bullish { background: rgba(38,166,154,0.2); color: #26a69a; }
        .badge.bearish { background: rgba(239,83,80,0.2); color: #ef5350; }

        .refresh-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .refresh-btn {
            background: #1a1a2e;
            color: #7b8cff;
            border: 1px solid #333;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .refresh-btn:hover { background: #252545; }
        .last-update { color: #555; font-size: 12px; }

        .section-title {
            font-size: 16px;
            color: #ccc;
            margin: 24px 0 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #1e1e2e;
        }

        .no-data {
            color: #555;
            text-align: center;
            padding: 40px;
            font-style: italic;
        }

        /* Delete button */
        .delete-btn {
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .delete-btn:hover {
            background: rgba(239,83,80,0.2);
            color: #ef5350;
        }

        /* Confirmation Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-box {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            text-align: center;
        }
        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 12px;
        }
        .modal-message {
            color: #999;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .modal-btn {
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .modal-btn.cancel {
            background: #333;
            color: #999;
        }
        .modal-btn.cancel:hover {
            background: #444;
            color: #ccc;
        }
        .modal-btn.confirm {
            background: #ef5350;
            color: #fff;
        }
        .modal-btn.confirm:hover {
            background: #f44336;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Trading Statistics Dashboard</h1>
        <a href="/" class="back-btn">Back to Chart</a>
    </div>

    <div class="container">
        <div class="refresh-bar">
            <button class="refresh-btn" onclick="loadAllStats()">Refresh</button>
            <span class="last-update" id="lastUpdate">Loading...</span>
            <span style="margin-left:auto; color:#555; font-size:12px;">Auto-refreshes every 30s</span>
        </div>

        <!-- Bracket Resolution Stats -->
        <div class="section-title">Bracket Resolution (Primary Metric)</div>
        <div class="stats-grid" id="bracketCards">
            <div class="card"><div class="no-data">Loading bracket stats...</div></div>
        </div>

        <!-- Bracket Trade Log -->
        <div class="section-title">Recent Bracket Trades</div>
        <div class="card" id="bracketTradesCard">
            <div class="no-data">Loading bracket trades...</div>
        </div>

        <!-- Setup Leaderboard -->
        <div class="section-title">Setup Leaderboard (Multi-Strategy Testing)</div>
        <div class="card" id="setupLeaderboardCard">
            <div class="no-data">Loading setup leaderboard...</div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-title">Delete Setup Signal History</div>
            <div class="modal-message">
                Are you sure you want to delete all trade history for <strong id="deleteSetupName"></strong>?
                <br><br>
                <span style="color:#ef5350">This action cannot be undone.</span>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="confirmDelete()">Delete History</button>
            </div>
        </div>
    </div>

    <script>
        // Delete modal state
        let deleteSetupId = null;

        function showDeleteModal(setupName, displayName) {
            deleteSetupId = setupName;
            document.getElementById('deleteSetupName').textContent = displayName;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            deleteSetupId = null;
            document.getElementById('deleteModal').classList.remove('active');
        }

        async function confirmDelete() {
            if (!deleteSetupId) return;

            const setupName = deleteSetupId;
            closeDeleteModal();

            try {
                const resp = await fetch(`/api/stats/setups/${setupName}/history`, {
                    method: 'DELETE'
                });

                if (resp.ok) {
                    const result = await resp.json();
                    console.log(`Deleted ${result.deleted_count} trades for ${setupName}`);
                    // Refresh stats
                    loadAllStats();
                } else {
                    const err = await resp.text();
                    console.error('Delete failed:', err);
                    alert('Failed to delete setup history: ' + err);
                }
            } catch (err) {
                console.error('Delete error:', err);
                alert('Error deleting setup history');
            }
        }

        // Close modal on background click
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('deleteModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeDeleteModal();
                }
            });
        });

        function formatTime(ts) {
            if (!ts) return '-';
            const d = new Date(ts * 1000);
            return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function winColor(rate) {
            if (rate === null || rate === undefined) return '#555';
            if (rate >= 0.6) return '#26a69a';
            if (rate >= 0.45) return '#ffca28';
            return '#ef5350';
        }

        function outcomeColor(outcome) {
            if (outcome === 'TARGET_HIT') return '#26a69a';
            if (outcome === 'STOP_HIT') return '#ef5350';
            if (outcome === 'TRAILING_STOP' || outcome === 'BREAKEVEN_STOP') return '#ffca28';
            if (outcome === 'TIMEOUT_PROFIT') return '#66bb6a';
            if (outcome === 'TIMEOUT_LOSS') return '#ff7043';
            if (outcome === 'TIMEOUT_SCRATCH') return '#888';
            return '#555';
        }

        function rColor(r) {
            if (r === null || r === undefined) return '#555';
            if (r >= 1.0) return '#26a69a';
            if (r > 0) return '#66bb6a';
            if (r > -0.5) return '#ffca28';
            return '#ef5350';
        }

        function renderBracketCards(bracketToday, bracketAll, bracket7d, bracket30d) {
            const container = document.getElementById('bracketCards');

            const sections = [
                { label: 'Today', data: bracketToday },
                { label: 'All Time', data: bracketAll },
                { label: '7-Day Rolling', data: bracket7d },
                { label: '30-Day Rolling', data: bracket30d },
            ];

            let html = '';
            for (const { label, data } of sections) {
                if (!data || !data.total_trades) {
                    html += `<div class="card"><h2>${label}</h2><div class="no-data">No bracket data</div></div>`;
                    continue;
                }
                const s = data;
                const wr = s.bracket_win_rate;
                const wrPct = wr !== null && wr !== undefined ? (wr * 100).toFixed(1) + '%' : 'N/A';
                const wrC = winColor(wr);
                const pr = s.profitable_rate;
                const prPct = pr !== null && pr !== undefined ? (pr * 100).toFixed(1) + '%' : 'N/A';

                html += `
                    <div class="card">
                        <h2>${label}</h2>
                        <div class="big-number" style="color:${wrC}">${wrPct}</div>
                        <div class="big-label">Bracket Win Rate (Target / (Target+Stop))</div>

                        <div class="stat-row">
                            <span class="stat-label">Total Trades</span>
                            <span class="stat-value blue">${s.total_trades}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Target Hits / Stop Hits</span>
                            <span class="stat-value"><span class="green">${s.target_hits || 0}</span> / <span class="red">${s.stop_hits || 0}</span></span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Trailing/BE Exits</span>
                            <span class="stat-value yellow">${s.trailing_exits || 0}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Timeouts / Scratches</span>
                            <span class="stat-value">${s.timeouts || 0} / ${s.scratches || 0}</span>
                        </div>

                        <div class="stat-row">
                            <span class="stat-label">Avg R-Multiple</span>
                            <span class="stat-value" style="color:${rColor(s.avg_r)}">${s.avg_r !== null ? s.avg_r.toFixed(3) + 'R' : 'N/A'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total R</span>
                            <span class="stat-value" style="color:${rColor(s.total_r)}">${s.total_r !== null ? s.total_r.toFixed(2) + 'R' : 'N/A'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Expectancy</span>
                            <span class="stat-value" style="color:${rColor(s.expectancy)}">${s.expectancy ? s.expectancy.toFixed(3) + 'R' : (s.avg_r ? s.avg_r.toFixed(3) + 'R' : 'N/A')}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">SQN</span>
                            <span class="stat-value" style="color:${s.sqn && s.sqn > 2 ? '#26a69a' : s.sqn && s.sqn > 1 ? '#ffca28' : '#ef5350'}">${s.sqn ? s.sqn.toFixed(2) : 'N/A'}</span>
                        </div>

                        <div class="stat-row">
                            <span class="stat-label">Profitable Rate</span>
                            <span class="stat-value" style="color:${winColor(pr)}">${prPct}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg MFE / MAE (R)</span>
                            <span class="stat-value"><span class="green">${s.avg_mfe_r ? s.avg_mfe_r.toFixed(2) : '-'}</span> / <span class="red">${s.avg_mae_r ? s.avg_mae_r.toFixed(2) : '-'}</span></span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg ETD from MFE (R)</span>
                            <span class="stat-value">${s.avg_etd_r ? s.avg_etd_r.toFixed(2) : '-'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg Bars Held</span>
                            <span class="stat-value">${s.avg_bars_held ? s.avg_bars_held.toFixed(1) : '-'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg Quality Score</span>
                            <span class="stat-value">${s.avg_quality ? s.avg_quality.toFixed(1) + '/100' : '-'}</span>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html || '<div class="card"><div class="no-data">No bracket resolution data yet. Requires ATR > 0 in trade signals.</div></div>';
        }

        function renderBracketTrades(trades) {
            const container = document.getElementById('bracketTradesCard');
            if (!trades || trades.length === 0) {
                container.innerHTML = '<div class="no-data">No bracket trades resolved yet.</div>';
                return;
            }

            let html = `<table class="predictions-table">
                <thead><tr>
                    <th>Time</th>
                    <th>Symbol</th>
                    <th>Setup</th>
                    <th>Dir</th>
                    <th>Entry</th>
                    <th>Stop</th>
                    <th>Target</th>
                    <th>Exit</th>
                    <th>Outcome</th>
                    <th>R-Mult</th>
                    <th>MFE(R)</th>
                    <th>MAE(R)</th>
                    <th>Bars</th>
                    <th>Quality</th>
                </tr></thead><tbody>`;

            for (const t of trades) {
                const dirClass = t.direction === 'LONG' ? 'bullish' : 'bearish';
                const oc = outcomeColor(t.outcome);
                const rc = rColor(t.r_multiple);
                html += `<tr>
                    <td>${formatTime(t.entry_time)}</td>
                    <td>${t.symbol || ''}</td>
                    <td style="color:#888;font-size:11px">${t.setup_name || '-'}</td>
                    <td><span class="badge ${dirClass}">${t.direction}</span></td>
                    <td>${t.entry_price ? t.entry_price.toFixed(1) : '-'}</td>
                    <td style="color:#ef5350">${t.stop_price ? t.stop_price.toFixed(1) : '-'}</td>
                    <td style="color:#26a69a">${t.target_price ? t.target_price.toFixed(1) : '-'}</td>
                    <td>${t.exit_price ? t.exit_price.toFixed(1) : '-'}</td>
                    <td style="color:${oc};font-weight:600">${t.outcome || '-'}</td>
                    <td style="color:${rc};font-weight:600">${t.r_multiple !== null ? t.r_multiple.toFixed(2) + 'R' : '-'}</td>
                    <td class="green">${t.mfe_r ? t.mfe_r.toFixed(2) : '-'}</td>
                    <td class="red">${t.mae_r ? t.mae_r.toFixed(2) : '-'}</td>
                    <td>${t.bars_held || '-'}</td>
                    <td>${t.quality_score ? t.quality_score.toFixed(0) : '-'}</td>
                </tr>`;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderSetupLeaderboard(data, readinessData) {
            const container = document.getElementById('setupLeaderboardCard');
            const leaderboard = data.leaderboard || [];
            const detectors = data.detectors || [];

            if (leaderboard.length === 0 && detectors.length === 0) {
                container.innerHTML = '<div class="no-data">No setup detectors registered yet.</div>';
                return;
            }

            let html = '';

            // Detector grid ‚Äî always show all registered setups
            if (detectors.length > 0) {
                const tierColors = {1: '#26a69a', 2: '#29b6f6', 3: '#ffca28', 4: '#ef5350'};
                const tierLabels = {1: 'T1', 2: 'T2', 3: 'T3', 4: 'T4'};
                const catIcons = {
                    breakout: 'üî∫', mean_reversion: 'üîÑ', momentum: '‚ö°', level: 'üìè',
                    volatility: 'üí•', micro: 'üî¨', vwap: 'üìä', unknown: '‚ùì'
                };
                // Build lookup from leaderboard data
                const statsMap = {};
                for (const s of leaderboard) {
                    statsMap[s.setup_name] = s;
                }
                // Readiness lookup
                const readinessMap = {};
                if (readinessData && readinessData.readiness) {
                    for (const r of readinessData.readiness) {
                        readinessMap[r.name] = r.readiness;
                    }
                }

                html += `<div style="margin-bottom:14px;color:#aaa;font-size:13px;font-weight:600">${detectors.length} Setups Registered &nbsp;|&nbsp; ${detectors.filter(d=>d.enabled).length} Enabled &nbsp;|&nbsp; ${detectors.reduce((s,d)=>s+d.signal_count,0)} Signals Emitted</div>`;
                html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:8px;margin-bottom:16px">';
                for (const d of detectors) {
                    const tc = tierColors[d.evidence_tier] || '#888';
                    const tl = tierLabels[d.evidence_tier] || '?';
                    const icon = catIcons[d.category] || '‚ùì';
                    const st = statsMap[d.name];
                    const hasTrades = st && st.total_trades > 0;

                    // Stats row
                    let statsRow = '';
                    if (hasTrades) {
                        const wr = st.bracket_win_rate !== null ? (st.bracket_win_rate * 100).toFixed(1) + '%' : '-';
                        const wrCol = st.bracket_win_rate >= 0.55 ? '#26a69a' : st.bracket_win_rate >= 0.45 ? '#ffca28' : '#ef5350';
                        const avgR = st.avg_r !== null ? st.avg_r.toFixed(2) + 'R' : '-';
                        const avgRCol = st.avg_r > 0 ? '#26a69a' : st.avg_r < 0 ? '#ef5350' : '#888';
                        const totalR = st.total_r !== null ? st.total_r.toFixed(1) + 'R' : '-';
                        const totalRCol = st.total_r > 0 ? '#26a69a' : st.total_r < 0 ? '#ef5350' : '#888';
                        statsRow = `
                            <div style="display:flex;justify-content:space-between;font-size:11px;margin-top:6px;padding-top:6px;border-top:1px solid #2a2a3a">
                                <span style="color:${wrCol};font-weight:700">${wr}</span>
                                <span style="color:#888">${st.total_trades} trades</span>
                                <span style="color:${avgRCol};font-weight:600">${avgR}</span>
                                <span style="color:${totalRCol};font-weight:600">${totalR}</span>
                            </div>`;
                    } else {
                        statsRow = `
                            <div style="font-size:10px;margin-top:6px;padding-top:6px;border-top:1px solid #2a2a3a;color:#444">
                                ${d.signal_count > 0 ? d.signal_count + ' signals ¬∑ awaiting resolution' : 'No signals yet'}
                            </div>`;
                    }

                    const pct = readinessMap[d.name] || 0;
                    const barCol = pct >= 75 ? '#26a69a' : pct >= 50 ? '#ffca28' : pct >= 25 ? '#ff8a65' : '#555';
                    const meterBar = `
                        <div style="margin-top:6px;padding-top:6px;border-top:1px solid #2a2a3a">
                            <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:3px">
                                <span style="color:#888">Confluence</span>
                                <span style="color:${barCol};font-weight:700">${pct.toFixed(1)}%</span>
                            </div>
                            <div style="background:#111;border-radius:3px;height:6px;overflow:hidden">
                                <div style="width:${pct}%;height:100%;background:${barCol};border-radius:3px;transition:width 0.5s"></div>
                            </div>
                        </div>`;

                    html += `<div style="background:#1e1e2f;border:1px solid ${d.enabled ? '#333' : '#2a1a1a'};border-radius:8px;padding:10px 12px;${!d.enabled ? 'opacity:0.5;' : ''}position:relative;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                            <span style="font-size:12px;font-weight:700;color:#ddd">${icon} ${d.display_name}</span>
                            <div style="display:flex;align-items:center;gap:6px">
                                <span style="font-size:10px;font-weight:700;color:${tc};background:${tc}22;padding:1px 6px;border-radius:4px">${tl}</span>
                                ${hasTrades ? `<button class="delete-btn" onclick="showDeleteModal('${d.name}', '${d.display_name}')" title="Delete history">üóëÔ∏è</button>` : ''}
                            </div>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:11px;color:#777">
                            <span>${d.category} ¬∑ ${d.hold_time}</span>
                        </div>
                        ${statsRow}
                        ${meterBar}
                    </div>`;
                }
                html += '</div>';
            }

            if (leaderboard.length === 0) {
                html += '<div class="no-data" style="padding:12px;color:#666">No resolved setup trades yet. Setups will appear in the leaderboard once signals fire and resolve.</div>';
                container.innerHTML = html;
                return;
            }

            html += `<table class="predictions-table">
                <thead><tr>
                    <th>Setup</th>
                    <th>Trades</th>
                    <th>Win Rate</th>
                    <th>Avg R</th>
                    <th>Total R</th>
                    <th>SQN</th>
                    <th>MFE(R)</th>
                    <th>MAE(R)</th>
                    <th>ETD(R)</th>
                    <th>Avg Bars</th>
                    <th>Targets</th>
                    <th>Stops</th>
                    <th>Timeouts</th>
                </tr></thead><tbody>`;

            for (const s of leaderboard) {
                const wr = s.bracket_win_rate;
                const wrColor = winColor(wr);
                const avgRColor = s.avg_r > 0 ? '#26a69a' : s.avg_r < 0 ? '#ef5350' : '#888';
                const totalRColor = s.total_r > 0 ? '#26a69a' : s.total_r < 0 ? '#ef5350' : '#888';
                const sqnColor = s.sqn >= 2 ? '#26a69a' : s.sqn >= 1 ? '#ffca28' : '#ef5350';

                html += `<tr>
                    <td style="font-weight:600;color:#ccc">${s.setup_name}</td>
                    <td>${s.total_trades}</td>
                    <td style="color:${wrColor};font-weight:600">${wr !== null ? (wr * 100).toFixed(1) + '%' : '-'}</td>
                    <td style="color:${avgRColor};font-weight:600">${s.avg_r !== null ? s.avg_r.toFixed(3) + 'R' : '-'}</td>
                    <td style="color:${totalRColor};font-weight:600">${s.total_r !== null ? s.total_r.toFixed(2) + 'R' : '-'}</td>
                    <td style="color:${sqnColor}">${s.sqn !== null ? s.sqn.toFixed(2) : '-'}</td>
                    <td class="green">${s.avg_mfe_r ? s.avg_mfe_r.toFixed(2) : '-'}</td>
                    <td class="red">${s.avg_mae_r ? s.avg_mae_r.toFixed(2) : '-'}</td>
                    <td>${s.avg_etd_r ? s.avg_etd_r.toFixed(2) : '-'}</td>
                    <td>${s.avg_bars_held ? s.avg_bars_held.toFixed(1) : '-'}</td>
                    <td class="green">${s.target_hits}</td>
                    <td class="red">${s.stop_hits}</td>
                    <td style="color:#ffca28">${s.timeouts}</td>
                </tr>`;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function loadAllStats() {
            try {
                const [resp, setupResp, readinessResp] = await Promise.all([
                    fetch('/api/stats/full'),
                    fetch('/api/stats/setups'),
                    fetch('/api/stats/setups/readiness'),
                ]);
                if (!resp.ok) {
                    const errText = await resp.text();
                    console.error('Stats API error:', resp.status, errText);
                    document.getElementById('lastUpdate').textContent =
                        'Stats API error: ' + resp.status;
                    return;
                }
                const data = await resp.json();

                renderBracketCards(data.bracket_today, data.bracket_all, data.bracket_7d, data.bracket_30d);
                renderBracketTrades(data.bracket_trades);
                if (setupResp.ok) {
                    const setupData = await setupResp.json();
                    const readinessData = readinessResp.ok ? await readinessResp.json() : {};
                    renderSetupLeaderboard(setupData, readinessData);
                }

                document.getElementById('lastUpdate').textContent =
                    'Last updated: ' + new Date().toLocaleTimeString();
            } catch (err) {
                console.error('Failed to load stats:', err);
                document.getElementById('lastUpdate').textContent = 'Error loading stats';
            }
        }

        // Load on page open
        loadAllStats();

        // Auto-refresh every 30 seconds
        setInterval(loadAllStats, 30000);
    </script>
</body>
</html>
